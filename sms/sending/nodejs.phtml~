<?php

?>
<h2>Send messages using Node.js</h2>
<p>
The Node.js code snippet below shows how to send SMS Messages using our API. 
</p>

<ul>
<li><a href="#basic" data-toggle="tab">Sending a message</a></li>
<li><a href="#from" data-toggle="tab">Sending message using sender id or shortcode parameter</a></li>
<li><a href="#enqueue" data-toggle="tab">Enqueue messages</a></li>
<li><a href="#premium" data-toggle="tab">Sending premium rated (subscription) messages</a></li>
<li><a href="#ondemand" data-toggle="tab">Sending premium rated (onDemand) messages</a></li>
</ul>

<div class="tab-content">

<div class="tab-pane fade in active" id="basic">
<h3>Sending a Message</h3>

<fieldset style="width:98%;" class='boxed code'>
<pre class="nodejsCode">
// We need this to build our post string

var querystring = require('querystring');
var https       = require('https');

// Your login credentials
var username = 'MyAfricasTalkingUsername';
var apikey   = 'MyAfricasTalkingApiKey';

function sendMessage() {
	
	// Define the recipient numbers in a comma separated string
	// Numbers should be in international format as shown
	var to      = '+254721XXXYYY,+852XXXYYYZZZ,+1XXXYYYZZZ';
	
	// And of course we want our recipients to know what we really do
	var message = "I'm a lumberjack and its ok, I sleep all night and I work all day";
	
	// Build the post string from an object
	
	var post_data = querystring.stringify({
	    'username' : username,
	    'to'       : to,
	    'message'  : message
	});
	
	var post_options = {
		host   : 'api.africastalking.com',
		path   : '/version1/messaging',
		method : 'POST',
		
		rejectUnauthorized : false,
		requestCert        : true,
		agent              : false,
		
		headers: {
		    'Content-Type' : 'application/x-www-form-urlencoded',
		    'Content-Length': post_data.length,
		    'Accept': 'application/json',
		    'apikey': apikey
		}
	};
	
	var post_req = https.request(post_options, function(res) {
	    res.setEncoding('utf8');
	    res.on('data', function (chunk) {
		    var jsObject   = JSON.parse(chunk);
		    var recipients = jsObject.SMSMessageData.Recipients;
		    if ( recipients.length > 0 ) {
		    	for (var i = 0; i < recipients.length; ++i ) {
		    		var logStr  = 'number=' + recipients[i].number;
		    		logStr     += ';cost='   + recipients[i].cost;
		    		logStr     += ';status=' + recipients[i].status;
		    		console.log(logStr);
		    		}
		    	} else {
		    		console.log('Error while sending: ' + jsObject.SMSMessageData.Message);
		    }
		});
	});
	
	// Add post parameters to the http request
	post_req.write(post_data);
	
	post_req.end();
}

//Call sendMessage method
sendMessage();

</pre>
</fieldset>
</div>

<div class="tab-pane fade" id="from">
<h3>Sending messages: Use short code/Sender id</h3>
<fieldset style="width:98%" class='boxed code'>
<pre class="nodejsCode">
// Sending Messages using sender id/short code

var querystring = require('querystring');
var https       = require('https');

var username = 'MyAfricasTalkingUsername';
var apikey   = 'MyAfricasTalkingApiKey';

function sendMessage() {
	
	var to      = '+254721XXXYYY,+852XXXYYYZZZ,+1XXXYYYZZZ';
	
	var message = "I'm a lumberjack and its ok, I sleep all night and I work all day";
	
	// Specify your AfricasTalking shortCode or sender id
	var from = "shortCode or senderId";
	
	var post_data = querystring.stringify({
		 'username' : username,
		 'to'       : to,
		 'message'  : message,
		 'from'     : from
	});
	
	var post_options = {
		host   : 'api.africastalking.com',
		path   : '/version1/messaging',
		method : 'POST',
		
		rejectUnauthorized : false,
		requestCert        : true,
		agent              : false,
		
		headers: {
		    'Content-Type' : 'application/x-www-form-urlencoded',
		    'Content-Length': post_data.length,
		    'Accept': 'application/json',
		    'apikey': apikey
		}
	};
	var post_req = https.request(post_options, function(res) {
		
		res.setEncoding('utf8');
		res.on('data', function (chunk) {
			var jsObject   = JSON.parse(chunk);
			var recipients = jsObject.SMSMessageData.Recipients;
			if ( recipients.length > 0 ) {
				for (var i = 0; i < recipients.length; ++i ) {
					var logStr  = 'number=' + recipients[i].number;
					logStr     += ';cost='   + recipients[i].cost;
					logStr     += ';status=' + recipients[i].status;
					console.log(logStr);
					}
				} else {
					console.log('Error while sending: ' + jsObject.SMSMessageData.Message);
				}
		});
	});
	
	post_req.write(post_data);
	
	post_req.end();
}

//Call sendMessage method
sendMessage();

</pre>	
</fieldset>
</div>

<div class="tab-pane fade" id="enqueue">
<h3>Sending messages: Queue messages to be sent later</h3>
<fieldset style="width:98%" class='boxed code'>
<pre class="javaCode">
// Message queueing

var querystring = require('querystring');
var https       = require('https');

var username = 'MyAfricasTalkingUsername';
var apikey   = 'MyAfricasTalkingApiKey';

function sendMessage() {
	
	var to      = '+254721XXXYYY,+852XXXYYYZZZ,+1XXXYYYZZZ';
	
	var message = "I'm a lumberjack and its ok, I sleep all night and I work all day";
	
	// enqueue flag is used to queue messages incase you are sending a high volume.
	// The default value is 0.
	var enqueue = 1;
	
	var post_data = querystring.stringify({
		  'username' : username,
		  'to'       : to,
		  'message'  : message,
		  'enqueue'  : enqueue
	});
	
	var post_options = {
		host   : 'api.africastalking.com',
		path   : '/version1/messaging',
		method : 'POST',
		
		rejectUnauthorized : false,
		requestCert        : true,
		agent              : false,
		
		headers: {
		    'Content-Type' : 'application/x-www-form-urlencoded',
		    'Content-Length': post_data.length,
		    'Accept': 'application/json',
		    'apikey': apikey
		}
	};
	var post_req = https.request(post_options, function(res) {
		
		res.setEncoding('utf8');
		res.on('data', function (chunk) {
			var jsObject   = JSON.parse(chunk);
			var recipients = jsObject.SMSMessageData.Recipients;
			if ( recipients.length > 0 ) {
				for (var i = 0; i < recipients.length; ++i ) {
					var logStr  = 'number=' + recipients[i].number;
					logStr     += ';cost='   + recipients[i].cost;
					logStr     += ';status=' + recipients[i].status;
					console.log(logStr);
					}
				} else {
					console.log('Error while sending: ' + jsObject.SMSMessageData.Message);
				}
		});
	});
	
	post_req.write(post_data);
	
	post_req.end();
}

//Call sendMessage method
sendMessage();

</pre>	
</fieldset>
</div>

<div class="tab-pane fade" id="premium">
<h3>Sending premium rated (subscription) messages</h3>
<fieldset style="width:98%" class='boxed code'>
<pre class="nodejsCode">
// Sending premium rated messages

var querystring = require('querystring');
var https       = require('https');

var username = 'MyAfricasTalkingUsername';
var apikey   = 'MyAfricasTalkingApiKey';

function sendMessage() {
	
	    var to      = '+254721XXXYYY';
	    
	    // Specify your premium shortcode and keyword
	    var shortCode = "XXXXX";
	    var keyword = "premiumKeyword";
	    
	    // Set the bulkSMSMode flag to 0 so that the subscriber gets charged
	    var bulkSMSMode = 0;
	    
	    // retryDurationInHours: The numbers of hours our API should retry to send the message 
	    // before giving a failure status incase it doesn't go through. It is optional
	    // incase it doesn't go through. It is optional
	    
	    var retryDurationInHours = "No. of hours to retry";
	    
	    var message = "No matter what, don't give up";
	    
    // Build the post string from an object
    var post_data = querystring.stringify({
	    'username'             : username,
	    'to'                   : to,
	    'message'              : message,
	    'from'                 : shortCode,
	    'keyword'              : keyword,
	    'retryDurationInHours' : retryDurationInHours
	});
	
	var post_options = {
		host   : 'api.africastalking.com',
		path   : '/version1/messaging',
		method : 'POST',
		
		rejectUnauthorized : false,
		requestCert        : true,
		agent              : false,
		
		headers: {
		    'Content-Type' : 'application/x-www-form-urlencoded',
		    'Content-Length': post_data.length,
		    'Accept': 'application/json',
		    'apikey': apikey
		}
	};
    
    var post_req = https.request(post_options, function(response) {
	    response.setEncoding('utf8');
	    response.on('data', function (chunk) {
	    	try {
	    		if(response.statusCode != 201)
	    		 throw chunk;
	    		 
	    		 var jsObject   = JSON.parse(chunk);
	    		 var recipients = jsObject.SMSMessageData.Recipients;
	    		 if ( recipients.length > 0 ) {
	    		 	for (var i = 0; i < recipients.length; ++i ) {
	    		 		var logStr  = 'number=' + recipients[i].number;
	    		 		logStr     += ';messageId='   + recipients[i].messageId;
	    		 		logStr     += ';status=' + recipients[i].status;
	    		 		console.log(logStr);
		    		}
		    	}
		    }
		   
		   catch(errorStr) {
		     console.log(errorStr);
		   }
		});
	});
    
    post_req.write(post_data);
    post_req.end();
}

sendMessage();
</pre>
</fieldset>
</div>

<div class="tab-pane fade" id="ondemand">
<h3>Sending premium rated (onDemand) messages</h3>
<fieldset style="width:98%" class='boxed code'>
<pre class="javaCode">
// Sending onDemand premium messages

var querystring = require('querystring');
var https       = require('https');

var username = 'MyAfricasTalkingUsername';
var apikey   = 'MyAfricasTalkingApiKey';

function sendMessage() {
	
	    var to      = '+254721XXXYYY';
	    
	    var shortCode = "XXXXX";
	    var keyword = "premiumKeyword"; // var keyword = null
	    
	    var bulkSMSMode = 0;
	    
	    // Set the linkId parameter
	    // linkId is received from the message sent by subscriber to your onDemand service
	    
	    var linkId = "messageLinkId"
	         
	    var retryDurationInHours = "No. of hours to retry";
	    
	    var message = "No matter what, don't give up";
	    
    // Build the post string from an object
    var post_data = querystring.stringify({
	    'username'             : username,
	    'to'                   : to,
	    'message'              : message,
	    'from'                 : shortCode,
	    'keyword'              : keyword,
	    'linkId'               : linkId,
	    'retryDurationInHours' : retryDurationInHours
	});
	
	var post_options = {
		host   : 'api.africastalking.com',
		path   : '/version1/messaging',
		method : 'POST',
		
		rejectUnauthorized : false,
		requestCert        : true,
		agent              : false,
		
		headers: {
		    'Content-Type' : 'application/x-www-form-urlencoded',
		    'Content-Length': post_data.length,
		    'Accept': 'application/json',
		    'apikey': apikey
		}
	};
    
    var post_req = https.request(post_options, function(response) {
	    response.setEncoding('utf8');
	    response.on('data', function (chunk) {
	    	try {
	    		if(response.statusCode != 201)
	    		 throw chunk;
	    		 
	    		 var jsObject   = JSON.parse(chunk);
	    		 var recipients = jsObject.SMSMessageData.Recipients;
	    		 if ( recipients.length > 0 ) {
	    		 	for (var i = 0; i < recipients.length; ++i ) {
	    		 		var logStr  = 'number=' + recipients[i].number;
	    		 		logStr     += ';messageId='   + recipients[i].messageId;
	    		 		logStr     += ';status=' + recipients[i].status;
	    		 		console.log(logStr);
		    		}
		    	}
		    }
		   
		   catch(errorStr) {
		     console.log(errorStr);
		   }
		});
	});
    
    post_req.write(post_data);
    post_req.end();
}

sendMessage();

</pre>
</fieldset>
</div>


</div>